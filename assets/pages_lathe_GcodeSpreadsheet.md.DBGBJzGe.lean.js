var U=Object.defineProperty;var F=(f,t,e)=>t in f?U(f,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):f[t]=e;var R=(f,t,e)=>F(f,typeof t!="symbol"?t+"":t,e);import{A,P as b,L as G,a as $}from"./chunks/Geometry.WDC_MvHR.js";import{U as h}from"./chunks/Utils.BFP07a3i.js";import{U as P,d as N,p as T,h as S,o as m,c as g,t as Z,n as k,_ as w,q as z,a3 as W,j as c,F as C,C as j,k as p,G as y,a as I}from"./chunks/framework.Cs8hIhTA.js";class J{constructor(t,e){R(this,"cells");R(this,"columnIndexMap");R(this,"COLUMNS");R(this,"ROWS");this.COLUMNS=t,this.ROWS=e,this.cells=P(Array(this.ROWS).fill("").map(()=>Array(this.COLUMNS.length).fill(""))),this.columnIndexMap=Object.fromEntries(this.COLUMNS.map((s,n)=>[s,n]))}evalCell(t){if(!this.isFormula(t))return t;const e=this.parseCellReferences(t.slice(1));return this.evaluateExpression(e)}isFormula(t){return t.startsWith("=")}parseCellReferences(t){return t.replace(/\b([A-Z])(\d{1,2})\b/g,(e,s,n)=>{const l=Number(n);this.isValidColName(s),this.isValidRow(l);const a=this.columnIndexMap[s];return`get(${l}, ${a})`})}evaluateExpression(t){try{return new Function("get",`return ${t}`)(this.getCellValue.bind(this))}catch(e){throw new Error(`#ERROR: ${e.message}`)}}getCellValue(t,e){this.isValidCoordinate(t,e);const s=this.cells[t][e];if(s==="")return null;const n=this.evalCell(s),l=h.roundNumber(Number(n));return Number.isFinite(l)?l:n}getCellValueRaw(t,e){return this.isValidCoordinate(t,e),this.cells[t][e]}setCellValue(t,e,s){this.isValidCoordinate(t,e),this.cells[t][e]=String(s)}setRowValue(t,e){if(this.isValidRow(t),e.length!==this.COLUMNS.length)throw new Error("Invalid row or value length mismatch.");this.cells[t].forEach((s,n)=>{this.setCellValue(t,n,e[n])})}setCellsFromArray(t){const e=t.length-this.cells.length;this.pushOrPopRow(e),t.forEach((s,n)=>{this.clearRow(n),this.setRowValue(n,s)})}setCellsFromObject(t){const e=t.length-this.cells.length;this.pushOrPopRow(e),t.forEach((s,n)=>{this.clearRow(n),this.setRowFromObject(n,s)})}setCellsFromString(t){const e=t.split(`
`).filter(n=>n.trim()!==""),s=e.length-this.cells.length;this.pushOrPopRow(s),e.forEach((n,l)=>{const a={},o=n.match(/([A-Z])(-?\d*\.?\d*)/g);o&&o.forEach(r=>{const i=r[0],d=r.slice(1),u=parseFloat(d);isNaN(u)||(a[i]=u)}),Object.keys(a).length>0&&(this.clearRow(l),this.setRowFromObject(l,a))})}getCellAsObject(t,e){this.isValidCoordinate(t,e);const s=this.COLUMNS[e],n=this.getCellValue(t,e);return n===null?{}:{[s]:n}}getRowAsObject(t){this.isValidRow(t);const e={};return this.COLUMNS.forEach((s,n)=>{const l=this.getCellValue(t,n);l!==null&&(e[s]=l)}),e}setRowFromObject(t,e){this.isValidRow(t);for(const s in e){this.isValidColName(s);const n=this.columnIndexMap[s];this.setCellValue(t,n,e[s])}}getObject(){const t=[];for(let e=0;e<this.ROWS;e++){const s={};for(let n=0;n<this.COLUMNS.length;n++){const l=this.getCellValue(e,n);if(l!==null&&l!==""){const a=this.COLUMNS[n];s[a]=l}}Object.keys(s).length>0&&t.push(s)}return t}clearRow(t){const e=new Array(this.COLUMNS.length).fill("");this.setRowValue(t,e)}pushRow(t=1){for(let e=0;e<t;e++)this.cells.push(new Array(this.COLUMNS.length).fill("")),this.ROWS++}popRow(t=1){for(let e=0;e<t;e++)this.cells.pop(),this.ROWS--}pushOrPopRow(t=0){t>=0?this.pushRow(t):this.popRow(Math.abs(t))}clearAllRow(){for(let t=0;t<this.ROWS;t++)this.clearRow(t)}toMap(t=this.getObject(),e=this.COLUMNS){return t.map(s=>{const n=new Map;return e.forEach(l=>{n.set(l,s[l])}),n})}toString(){return this.toMap().map(e=>[...e].filter(s=>s[1]!==void 0).map(s=>[s[0],h.roundNumber(s[1])]).map(s=>s.join("")).flat().join(" ")).join(`
`)}toArray(){return this.cells}isValidCoordinate(t,e){this.isValidRow(t),this.isValidCol(e)}isValidRow(t){if(!(t>=0&&t<this.ROWS&&t<this.cells.length))throw new Error(`#ERROR: Invalid row index (${t})`)}isValidCol(t){if(!(t>=0&&t<this.COLUMNS.length&&t<this.cells[0].length))throw new Error(`#ERROR: Invalid col index (${t})`)}isValidColName(t){if(!(t in this.columnIndexMap))throw new Error(`#ERROR: Invalid col name (${t})`)}}let x=class extends J{constructor(t=["G","X","Z","U","W","A","C","R"],e=10,s=`G00 X94. Z1.
      G1 Z0.02
      A90.
      X98.1 Z-2.8 A15. R0.5
      Z-45.`){super(t,e),this.setCellsFromString(s)}normalizeToObject(){const t=this.getObject(),e={G:void 0,X:void 0,Z:void 0,U:void 0,W:void 0},s=Object.assign({},e),n=Object.assign({},e);for(let l=0;l<t.length;l++){if(l==0){Object.assign(s,t[l]);continue}Object.assign(n,e,t[l]),"GXZ".split("").forEach(a=>{n[a]===void 0&&(t[l][a]=s[a])}),n.U!==void 0?(t[l].X=Number(s.X+n.U),delete t[l].U):n.W!==void 0&&(t[l].Z=Number(s.Z+n.W),delete t[l].W),Object.assign(s,t[l])}return t}normalize(){return this.normalizeToObject().forEach((t,e)=>{this.clearRow(e),this.setRowFromObject(e,t)}),this}unnormalizeToObject(t=this.getObject()){const e={G:-999999,X:-999999,Z:-999999},s={G:void 0,X:void 0,Z:void 0};for(let n=0;n<t.length;n++)Object.assign(s,t[n]),Object.keys(e).forEach(l=>{s[l]===e[l]&&delete t[n][l]}),Object.assign(e,s);return t}unnormalize(){return this.unnormalizeToObject().forEach((t,e)=>{this.clearRow(e),this.setRowFromObject(e,t)}),this}reverseG123Path(){let t=this.toG123().normalize().cells.toReversed();if(!t||t.length===0)return;t=h.transposeMatrix(t);const e=this.COLUMNS.findIndex(n=>n==="G"),s=this.COLUMNS.findIndex(n=>n==="R");return t[e]=t[e].map(n=>{switch(n){case"2":return"3";case"3":return"2";default:return n}}),t[e]=h.shiftFirst(t[e],1),t[s]=h.shiftFirst(t[s],1),t=h.transposeMatrix(t),this.setCellsFromArray(t),this.unnormalize(),this}offsetG123Path(t=0,e=0){let s=this.toG123().normalize().cells;if(!s||s.length===0)return;s=h.transposeMatrix(s);const n=this.COLUMNS.findIndex(o=>o==="X"),l=this.COLUMNS.findIndex(o=>o==="Z"),a=[n,l];for(let o=0;o<s.length;o++){if(!a.includes(o))continue;let r=0;o===n&&(r=t),o===l&&(r=e);const i=s[o];s[o]=i.map(d=>d.trim()!==""&&h.isNumber(Number(d))?(Number(d)+r).toString():d)}return s=h.transposeMatrix(s),this.setCellsFromArray(s),this.unnormalize(),this}scalerG123Path(t=1,e=!1){let s=this.toG123().normalize().cells;if(!s||s.length===0)return;s=h.transposeMatrix(s);const n=this.COLUMNS.findIndex(o=>o==="G"),l=this.COLUMNS.findIndex(o=>o==="A"),a=[n,l];for(let o=0;o<s.length;o++){if(a.includes(o))continue;const r=s[o];s[o]=r.map(i=>i.trim()!==""&&h.isNumber(Number(i))?(Number(i)*t).toString():i)}return s=h.transposeMatrix(s),this.setCellsFromArray(s),e||this.unnormalize(),this}crcG123Path(t=0,e=0){}toSvg(t=1){const e=this.toG123(!1).scalerG123Path(t,!0).getObject(),s={},n=["M 0 0"],l=(o,r)=>b.fromArrayXZ([o,r]).toArray().join(" "),a={0:o=>`L ${l(o.X,o.Z)}`,1:o=>`L ${l(o.X,o.Z)}`,2:o=>`A ${o.R} ${o.R} 0 0 0 ${l(o.X,o.Z)}`,3:o=>`A ${o.R} ${o.R} 0 0 1 ${l(o.X,o.Z)}`};return e.forEach(o=>{const r=o.G.toString();n.push(a[r](o)),Object.assign(s,o)}),n.push("Z"),n.join(" ")}toThree(t=1){const e=this.toG123(!1).scalerG123Path(t,!0).getObject(),s={},n={G:0,X:0,Z:0},l=[],a=r=>o(r).toArray(),o=r=>new $(r.X,r.Z).toPoint();for(let r=0;r<e.length;r++){Object.assign(s,e[r]),Object.assign(n,e[r-1]);const i=s.G;if(i==0||i==1){const[d,u,v,O]=[...a(n),...a(s)];l.push([i,[d,-u,v,-O]])}if(i==2||i==3){const u=A.createArcFromTwoPointAndRadius(o(n),o(s),s.R).filter(X=>X.type===-1&&X.getGcodeDirection()===i)[0],[v,O]=u.center.toArray(),{radius:V,startAngleRad:M,endAngleRad:L}=u,E=u.direction===-1;l.push([i,[v,-O,V],M,L,E])}console.log(l.at(-1))}return l}applyCValueToXAdjustment(t=this.getObject(),e=this.normalizeToObject()){for(let s=0;s<e.length;s++){const n=e[s],l=e[s-1],a=e[s+1];if(n.G===1&&n.C!==void 0){const o={start:b.fromObjectXZ({x:l.X,z:l.Z}),intersection:b.fromObjectXZ({x:n.X,z:n.Z}),end:b.fromObjectXZ({x:a.X,z:a.Z}),length:n.C},r=G.createFillet(o.start,o.intersection,o.end,o.length),i=r[1].start.toObjectXZ(),d=r[1].end.toObjectXZ();e[s]={G:1,X:i.x,Z:i.z},e.splice(s+1,0,Object.assign({G:1,X:d.x,Z:d.z})),t.splice(s+1,0,Object.assign({G:1,X:d.x,Z:d.z})),s++}}return e}applyAValueToAdjustment(t=this.getObject(),e=this.normalizeToObject()){for(let s=0;s<e.length;s++){const n=e[s],l=e[s-1],a=t[s],o=t[s-1];if(e[s+1],a.X===void 0&&a.Z===void 0&&[0,90,180,360,-90,-180,-360].includes(a.A))(a.A==90||a.A==-90)&&(e[s]={G:1,Z:l.Z},t[s]={G:1,Z:l.Z}),(a.A==0||a.A==180||a.A==-180||a.A==360||a.A==-360)&&(e[s]={G:1,X:l.X},t[s]={G:1,X:l.X});else if(n.G===1&&n.A!==void 0){if(a.X===void 0||a.Z===void 0){const r={start:b.fromObjectXZ({x:l.X,z:l.Z}),end:b.fromObjectXZ({x:(a==null?void 0:a.X)||NaN,z:(a==null?void 0:a.Z)||NaN}),angle:n.A},i=G.createLineFromAngle(r.start,r.end,r.angle);i.start.toObjectXZ();const d=i.end.toObjectXZ();e[s]={G:1,X:d.x,Z:d.z}}else if(a.X!==void 0&&a.Z!==void 0){const r={start:b.fromObjectXZ({x:(o==null?void 0:o.X)||NaN,z:(o==null?void 0:o.Z)||NaN}),end:b.fromObjectXZ({x:n.X,z:n.Z}),angle:n.A},i=G.createLineFromAngle(r.start,r.end,r.angle),d=i.start.toObjectXZ();i.end.toObjectXZ(),delete e[s].A,e[s-1]={G:1,X:d.x,Z:d.z}}}}return e}applyRValueToAdjustment(t=this.getObject(),e=this.normalizeToObject()){for(let s=0;s<e.length;s++){const n=e[s],l=e[s-1],a=e[s+1];if(n.G===1&&n.R!==void 0){const o={start:b.fromObjectXZ({x:l.X,z:l.Z}),intersection:b.fromObjectXZ({x:n.X,z:n.Z}),end:b.fromObjectXZ({x:a.X,z:a.Z}),radius:n.R},r=A.createFillet(o.start,o.intersection,o.end,o.radius),i=r.start.toObjectXZ(),d=r.end.toObjectXZ(),u=r.radius,v=r.getGcodeDirection();e[s]={G:1,X:i.x,Z:i.z},e.splice(s+1,0,Object.assign({G:v,X:d.x,Z:d.z,R:u})),t.splice(s+1,0,Object.assign({G:v,X:d.x,Z:d.z,R:u})),s++}}return e}toG123(t=!0){const e=this.getObject(),s=this.normalizeToObject(),n=this.applyCValueToXAdjustment(e,s);return this.applyAValueToAdjustment(e,n),this.applyRValueToAdjustment(e,n),t||this.unnormalizeToObject(n),this.setCellsFromObject(n),this}};const B=["title"],_=["value"],H={key:1},Y=N({__name:"GcodeSpreadsheetWidet",props:{sheet:x,rowIndex:Number,colIndex:Number},setup(f){const t=f,{sheet:e,rowIndex:s,colIndex:n}=t,l=T(!1),a=S(()=>e.getCellValue(s,n)),o=S(()=>e==null?void 0:e.getCellValueRaw(s,n));function r(i){l.value=!1,e==null||e.setCellValue(s,n,i.target.value.trim())}return(i,d)=>(m(),g("div",{class:k(["cell",{edit:l.value}]),title:o.value,onClick:d[1]||(d[1]=u=>l.value=!0)},[l.value?(m(),g("input",{key:0,value:o.value,onChange:r,onBlur:r,onVnodeMounted:d[0]||(d[0]=({el:u})=>u.focus())},null,40,_)):(m(),g("span",H,Z(a.value),1))],10,B))}}),q=w(Y,[["__scopeId","data-v-d12825b8"]]),Q={class:"button-container"},K=N({__name:"GcodeSpreadsheet",setup(f){const t=new x,e=t.cells,s=S(()=>e.length),n=t.COLUMNS;z(e,()=>console.log(e),{immediate:!0,deep:!0});const l=()=>{const r="#"+h.utoa(JSON.stringify(e));return history.replaceState({},"",r),r},a=(r=location.hash)=>{const i="eNqLjlYyUNJRsjQBEoZAjIJidaJhggZ6BkbYpNHELEGGIclZWuiBDNA10rOAqzE0hRlpimSErglUGK/59JaJBQBXJzAJ";r.startsWith("#")&&(r=r.slice(1));let d;try{d=JSON.parse(h.atou(r))}catch(u){console.error(u),alert("Failed to load code from URL."),d=JSON.parse(h.atou(i))}console.log(d),t.setCellsFromArray(d)},o=()=>{const r="#"+h.utoa(JSON.stringify(t.toThree()));window.open(location.origin+"/xlathe-vitepress-web/pages/lathe/GcodeThree.html"+r,"_blank")};return(r,i)=>(m(),g(C,null,[i[14]||(i[14]=W("<details data-v-d3fb7d01><summary data-v-d3fb7d01>TODO LIST</summary><dl data-v-d3fb7d01><dt data-v-d3fb7d01>-</dt><dd data-v-d3fb7d01>禁用某单元格</dd><dd data-v-d3fb7d01>单元格状态：新增/修改/删除</dd><dd data-v-d3fb7d01>设置某单元格值</dd><dd data-v-d3fb7d01>某单元格值 &lt;-&gt; Gcode</dd><dd data-v-d3fb7d01>-</dd><dd data-v-d3fb7d01>设置某列值</dd><dd data-v-d3fb7d01>某列值 &lt;-&gt; Gcode</dd><dd data-v-d3fb7d01>-</dd><dd data-v-d3fb7d01>[-]G1-ACR &lt;-&gt; G1/2/3</dd><dd data-v-d3fb7d01>[*]紧凑型 G1/2/3</dd><dd data-v-d3fb7d01>[*]G1/2/3 -&gt; GibbsCAM AptCL</dd><dd data-v-d3fb7d01>[*]逆转 G1/2/3</dd><dd data-v-d3fb7d01>[*]G1/2/3 -&gt; SVG</dd><dd data-v-d3fb7d01>[*]G1/2/3 XZ偏移</dd><dd data-v-d3fb7d01>[*]hash 数据存储</dd><dd data-v-d3fb7d01>[*]操作列表</dd><dd data-v-d3fb7d01>[*]尺寸输入框</dd><dd data-v-d3fb7d01>[*]公制/英制切换开关</dd><dd data-v-d3fb7d01>-</dd><dd data-v-d3fb7d01>表达式输入逻辑：两空格进行中差计算，$进行单元格数据引用，</dd></dl></details>",1)),c("table",null,[c("thead",null,[c("tr",null,[i[13]||(i[13]=c("th",null,null,-1)),(m(!0),g(C,null,j(p(n),d=>(m(),g("th",null,Z(d),1))),256))])]),c("tbody",null,[(m(!0),g(C,null,j(Array(s.value),(d,u)=>(m(),g("tr",null,[c("th",null,Z(u),1),(m(!0),g(C,null,j(p(n),(v,O)=>(m(),g("td",null,[y(q,{sheet:p(t),"row-index":u,"col-index":O},null,8,["sheet","row-index","col-index"])]))),256))]))),256))])]),c("div",Q,[c("input",{type:"button",onClick:i[0]||(i[0]=d=>p(t).pushRow()),value:"增加行"}),c("input",{type:"button",onClick:i[1]||(i[1]=d=>p(t).popRow()),value:"删除行"}),c("input",{type:"button",onClick:i[2]||(i[2]=d=>p(t).clearAllRow()),value:"清除所有行内容"}),c("input",{type:"button",onClick:i[3]||(i[3]=d=>p(t).toG123()),value:"转为 G123 代码"}),c("input",{type:"button",onClick:i[4]||(i[4]=d=>p(t).reverseG123Path()),value:"逆转 G123 代码"}),c("input",{type:"button",onClick:i[5]||(i[5]=d=>p(t).scalerG123Path()),value:"缩放 G123 代码"}),c("input",{type:"button",onClick:i[6]||(i[6]=d=>p(t).offsetG123Path()),value:"偏移 G123 代码"}),c("input",{type:"button",onClick:i[7]||(i[7]=d=>p(t).crcG123Path()),value:"半径补偿 G123 代码"}),c("input",{type:"button",onClick:i[8]||(i[8]=d=>p(t).normalize()),value:"归一化 代码"}),c("input",{type:"button",onClick:i[9]||(i[9]=d=>p(t).unnormalize()),value:"反归一化 代码"}),c("input",{type:"button",onClick:i[10]||(i[10]=d=>o()),value:"显示 G123 代码"}),c("input",{type:"button",onClick:i[11]||(i[11]=d=>l()),value:"转为 HASH"}),c("input",{type:"button",onClick:i[12]||(i[12]=d=>a()),value:"从 HASH 读取"})])],64))}}),D=w(K,[["__scopeId","data-v-d3fb7d01"]]),it=JSON.parse('{"title":"GcodeSpreadsheet","description":"","frontmatter":{},"headers":[],"relativePath":"pages/lathe/GcodeSpreadsheet.md","filePath":"pages/lathe/GcodeSpreadsheet.md"}'),tt={name:"pages/lathe/GcodeSpreadsheet.md"},rt=Object.assign(tt,{setup(f){return(t,e)=>(m(),g("div",{"data-pagefind-body":!0},[e[0]||(e[0]=c("h1",{id:"gcodespreadsheet",tabindex:"-1"},[I("GcodeSpreadsheet "),c("a",{class:"header-anchor",href:"#gcodespreadsheet","aria-label":'Permalink to "GcodeSpreadsheet"'},"​")],-1)),e[1]||(e[1]=c("p",null,"This is a GcodeSpreadsheet component.",-1)),y(D)]))}});export{it as __pageData,rt as default};
